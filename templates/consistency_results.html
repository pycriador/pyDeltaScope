{% extends "base.html" %}

{% block title %}Resultados da Consistência - DeltaScope{% endblock %}

{% block content %}
<div id="consistencyResultsSection">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2><i class="fas fa-check-circle me-2"></i>Resultados da Verificação de Consistência</h2>
        <a href="/consistencia" class="btn btn-secondary">
            <i class="fas fa-arrow-left me-2"></i>Voltar para Consistência
        </a>
    </div>
    
    <!-- Check Info -->
    <div class="card shadow mb-4">
        <div class="card-header bg-primary text-white">
            <h5 class="mb-0"><i class="fas fa-info-circle me-2"></i>Informações da Verificação</h5>
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-6 mb-3">
                    <h6 class="text-muted mb-2"><i class="fas fa-cog me-2"></i>Configuração</h6>
                    <p class="mb-0"><strong>{{ config.name }}</strong></p>
                    {% if config.description %}
                    <small class="text-muted">{{ config.description }}</small>
                    {% endif %}
                </div>
                <div class="col-md-6 mb-3">
                    <h6 class="text-muted mb-2"><i class="fas fa-hashtag me-2"></i>ID da Verificação</h6>
                    <p class="mb-0"><code>{{ check.id }}</code></p>
                </div>
                <div class="col-md-6 mb-3">
                    <h6 class="text-muted mb-2"><i class="fas fa-calendar me-2"></i>Data de Execução</h6>
                    <p class="mb-0">{{ check.executed_at.strftime('%d/%m/%Y %H:%M:%S') if check.executed_at else '-' }}</p>
                </div>
                <div class="col-md-6 mb-3">
                    <h6 class="text-muted mb-2"><i class="fas fa-chart-bar me-2"></i>Status</h6>
                    <p class="mb-0">
                        {% if check.status == 'completed' %}
                        <span class="badge bg-success">Concluído</span>
                        {% elif check.status == 'failed' %}
                        <span class="badge bg-danger">Falhou</span>
                        {% else %}
                        <span class="badge bg-warning">Em Andamento</span>
                        {% endif %}
                    </p>
                </div>
                <div class="col-md-6 mb-3">
                    <h6 class="text-muted mb-2"><i class="fas fa-database me-2"></i>Tabela Origem</h6>
                    <p class="mb-0"><code>{{ config.source_table }}</code></p>
                </div>
                <div class="col-md-6 mb-3">
                    <h6 class="text-muted mb-2"><i class="fas fa-database me-2"></i>Tabela Destino</h6>
                    <p class="mb-0"><code>{{ config.target_table }}</code></p>
                </div>
                <div class="col-md-12 mb-3">
                    <h6 class="text-muted mb-2"><i class="fas fa-exclamation-triangle me-2"></i>Total de Inconsistências</h6>
                    <p class="mb-0"><strong class="text-danger" style="font-size: 1.5rem;">{{ check.total_inconsistencies or 0 }}</strong></p>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Export Buttons -->
    <div class="card shadow mb-4">
        <div class="card-header bg-success text-white">
            <h5 class="mb-0"><i class="fas fa-download me-2"></i>Exportar Resultados</h5>
        </div>
        <div class="card-body">
            <div class="btn-group" role="group">
                <button type="button" class="btn btn-success" onclick="exportToJSON()">
                    <i class="fas fa-file-code me-2"></i>Exportar JSON
                </button>
                <button type="button" class="btn btn-info" onclick="exportToCSV()">
                    <i class="fas fa-file-csv me-2"></i>Exportar CSV
                </button>
                <button type="button" class="btn btn-secondary" onclick="exportToTXT()">
                    <i class="fas fa-file-alt me-2"></i>Exportar TXT
                </button>
            </div>
        </div>
    </div>
    
    <!-- Results Table -->
    <div class="card shadow mb-4">
        <div class="card-header bg-info text-white">
            <h5 class="mb-0"><i class="fas fa-list me-2"></i>Inconsistências Encontradas</h5>
        </div>
        <div class="card-body">
            {% if results %}
            <div class="table-responsive">
                <table id="resultsTable" class="table table-striped table-hover">
                    <thead class="table-light">
                        <tr>
                            <th>Chaves de Busca</th>
                            <th>Campo</th>
                            <th>Tipo de Inconsistência</th>
                            <th>Valor Origem</th>
                            <th>Valor Destino</th>
                            <th>Data de Detecção</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for result in results %}
                        <tr>
                            <td>
                                {% for key, value in result.join_key_values.items() %}
                                <small><code>{{ key }}: {{ value }}</code></small><br>
                                {% endfor %}
                            </td>
                            <td><strong>{{ result.field_name or '-' }}</strong></td>
                            <td>
                                {% if result.inconsistency_type == 'value_mismatch' %}
                                <span class="badge bg-warning">Valores Diferentes</span>
                                {% elif result.inconsistency_type == 'missing_in_target' %}
                                <span class="badge bg-danger">Ausente no Destino</span>
                                {% elif result.inconsistency_type == 'missing_in_source' %}
                                <span class="badge bg-info">Ausente na Origem</span>
                                {% else %}
                                <span class="badge bg-secondary">{{ result.inconsistency_type or '-' }}</span>
                                {% endif %}
                            </td>
                            <td>
                                <code class="source-value-code">
                                    {% if result.source_value is none %}
                                    <em class="text-muted">null</em>
                                    {% elif result.source_value|length > 50 %}
                                    {{ result.source_value[:50] }}...
                                    {% else %}
                                    {{ result.source_value }}
                                    {% endif %}
                                </code>
                            </td>
                            <td>
                                <code class="target-value-code">
                                    {% if result.target_value is none %}
                                    <em class="text-muted">null</em>
                                    {% elif result.target_value|length > 50 %}
                                    {{ result.target_value[:50] }}...
                                    {% else %}
                                    {{ result.target_value }}
                                    {% endif %}
                                </code>
                            </td>
                            <td>
                                <small class="text-muted">
                                    {% if result.detected_at %}
                                        {% if result.detected_at is string %}
                                            {{ result.detected_at }}
                                        {% else %}
                                            {{ result.detected_at.strftime('%d/%m/%Y %H:%M:%S') }}
                                        {% endif %}
                                    {% else %}
                                        -
                                    {% endif %}
                                </small>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% else %}
            <div class="alert alert-success">
                <i class="fas fa-check-circle me-2"></i>
                Nenhuma inconsistência encontrada! Os dados estão consistentes entre as tabelas.
            </div>
            {% endif %}
        </div>
    </div>
</div>

<script>
const checkId = {{ check.id }};
const results = {{ results|tojson }};

function exportToJSON() {
    const dataStr = JSON.stringify(results, null, 2);
    const dataBlob = new Blob([dataStr], { type: 'application/json' });
    const url = URL.createObjectURL(dataBlob);
    const link = document.createElement('a');
    link.href = url;
    link.download = `consistency_results_${checkId}.json`;
    link.click();
    URL.revokeObjectURL(url);
}

function exportToCSV() {
    if (results.length === 0) {
        alert('Nenhum resultado para exportar');
        return;
    }
    
    const headers = ['Chaves de Busca', 'Campo', 'Tipo de Inconsistência', 'Valor Origem', 'Valor Destino', 'Data de Detecção'];
    const rows = results.map(result => {
        const joinKeys = Object.entries(result.join_key_values || {}).map(([k, v]) => `${k}:${v}`).join('; ');
        return [
            `"${joinKeys}"`,
            `"${result.field_name || ''}"`,
            `"${result.inconsistency_type || ''}"`,
            `"${(result.source_value || '').replace(/"/g, '""')}"`,
            `"${(result.target_value || '').replace(/"/g, '""')}"`,
            `"${result.detected_at || ''}"`
        ];
    });
    
    const csv = [headers.join(','), ...rows.map(row => row.join(','))].join('\n');
    const dataBlob = new Blob(['\ufeff' + csv], { type: 'text/csv;charset=utf-8;' });
    const url = URL.createObjectURL(dataBlob);
    const link = document.createElement('a');
    link.href = url;
    link.download = `consistency_results_${checkId}.csv`;
    link.click();
    URL.revokeObjectURL(url);
}

function exportToTXT() {
    if (results.length === 0) {
        alert('Nenhum resultado para exportar');
        return;
    }
    
    let txt = `Resultados da Verificação de Consistência\n`;
    txt += `ID da Verificação: ${checkId}\n`;
    txt += `Data: ${new Date().toLocaleString('pt-BR')}\n`;
    txt += `Total de Inconsistências: ${results.length}\n\n`;
    txt += '='.repeat(80) + '\n\n';
    
    results.forEach((result, index) => {
        txt += `Inconsistência ${index + 1}:\n`;
        txt += `  Chaves de Busca: ${JSON.stringify(result.join_key_values)}\n`;
        txt += `  Campo: ${result.field_name || '-'}\n`;
        txt += `  Tipo: ${result.inconsistency_type || '-'}\n`;
        txt += `  Valor Origem: ${result.source_value || 'null'}\n`;
        txt += `  Valor Destino: ${result.target_value || 'null'}\n`;
        txt += `  Data de Detecção: ${result.detected_at || '-'}\n`;
        txt += '\n' + '-'.repeat(80) + '\n\n';
    });
    
    const dataBlob = new Blob([txt], { type: 'text/plain' });
    const url = URL.createObjectURL(dataBlob);
    const link = document.createElement('a');
    link.href = url;
    link.download = `consistency_results_${checkId}.txt`;
    link.click();
    URL.revokeObjectURL(url);
}
</script>
{% endblock %}

