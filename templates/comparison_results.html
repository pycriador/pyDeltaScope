{% extends "base.html" %}

{% block title %}Resultados da Comparação - DeltaScope{% endblock %}

{% block content %}
<div id="comparisonResultsSection">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2><i class="fas fa-file-alt me-2"></i>Resultados da Comparação</h2>
        <a href="/relatorios" class="btn btn-secondary">
            <i class="fas fa-arrow-left me-2"></i>Voltar para Relatórios
        </a>
    </div>
    
    <!-- Comparison Info -->
    <div class="card shadow mb-4">
        <div class="card-header bg-primary text-white">
            <h5 class="mb-0"><i class="fas fa-info-circle me-2"></i>Informações da Comparação</h5>
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-6 mb-3">
                    <h6 class="text-muted mb-2"><i class="fas fa-folder me-2"></i>Projeto</h6>
                    <p class="mb-0"><strong>{{ project.name }}</strong></p>
                </div>
                <div class="col-md-6 mb-3">
                    <h6 class="text-muted mb-2"><i class="fas fa-hashtag me-2"></i>ID da Comparação</h6>
                    <p class="mb-0"><code>{{ comparison.id }}</code></p>
                </div>
                <div class="col-md-6 mb-3">
                    <h6 class="text-muted mb-2"><i class="fas fa-calendar me-2"></i>Data de Execução</h6>
                    <p class="mb-0">{{ comparison.executed_at.strftime('%d/%m/%Y %H:%M:%S') if comparison.executed_at else '-' }}</p>
                </div>
                <div class="col-md-6 mb-3">
                    <h6 class="text-muted mb-2"><i class="fas fa-chart-bar me-2"></i>Status</h6>
                    <p class="mb-0">
                        {% if comparison.status == 'completed' %}
                        <span class="badge bg-success">Concluído</span>
                        {% elif comparison.status == 'failed' %}
                        <span class="badge bg-danger">Falhou</span>
                        {% else %}
                        <span class="badge bg-warning">Em Andamento</span>
                        {% endif %}
                    </p>
                </div>
                <div class="col-md-6 mb-3">
                    <h6 class="text-muted mb-2"><i class="fas fa-play-circle me-2"></i>Tipo de Execução</h6>
                    <p class="mb-0">
                        {% if scheduled_task %}
                        <span class="badge bg-info">
                            <i class="fas fa-clock me-1"></i>Agendamento: {{ scheduled_task.name }}
                        </span>
                        {% else %}
                        <span class="badge bg-secondary">
                            <i class="fas fa-hand-pointer me-1"></i>Execução Manual
                        </span>
                        {% endif %}
                    </p>
                </div>
                <div class="col-md-12 mb-3">
                    <h6 class="text-muted mb-2"><i class="fas fa-exclamation-triangle me-2"></i>Total de Diferenças</h6>
                    <p class="mb-0"><strong class="text-primary" style="font-size: 1.5rem;">{{ comparison.total_differences or 0 }}</strong></p>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Export and Webhook Buttons -->
    <div class="card shadow mb-4">
        <div class="card-header bg-success text-white">
            <h5 class="mb-0"><i class="fas fa-download me-2"></i>Exportar Resultados</h5>
        </div>
        <div class="card-body">
            <div class="btn-group me-2" role="group">
                <button type="button" class="btn btn-success" onclick="exportToJSON()">
                    <i class="fas fa-file-code me-2"></i>Exportar JSON
                </button>
                <button type="button" class="btn btn-info" onclick="exportToCSV()">
                    <i class="fas fa-file-csv me-2"></i>Exportar CSV
                </button>
                <button type="button" class="btn btn-secondary" onclick="exportToTXT()">
                    <i class="fas fa-file-alt me-2"></i>Exportar TXT
                </button>
            </div>
            <button type="button" class="btn btn-primary" onclick="openBulkWebhookModal()">
                <i class="fas fa-paper-plane me-2"></i>Enviar Todas as Diferenças para Webhook
            </button>
        </div>
    </div>
    
    <!-- Results Table -->
    <div class="card shadow mb-4">
        <div class="card-header bg-info text-white">
            <h5 class="mb-0"><i class="fas fa-list me-2"></i>Diferenças Encontradas</h5>
        </div>
        <div class="card-body">
            {% if results %}
            <div class="table-responsive">
                <table id="resultsTable" class="table table-striped table-hover">
                    <thead class="table-light">
                        <tr>
                            <th>ID do Registro</th>
                            <th>Campo</th>
                            <th>Tipo de Mudança</th>
                            <th>Valor Origem</th>
                            <th>Valor Destino</th>
                            <th>JSON_RAW (Dados Completos do Destino)</th>
                            <th>Data de Detecção</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for result in results %}
                        <tr>
                            <td><code>{{ result.record_id or '-' }}</code></td>
                            <td><strong>{{ result.field_name or '-' }}</strong></td>
                            <td>
                                {% if result.change_type == 'added' %}
                                <span class="badge bg-success">Adicionado</span>
                                {% elif result.change_type == 'modified' %}
                                <span class="badge bg-warning">Modificado</span>
                                {% elif result.change_type == 'deleted' %}
                                <span class="badge bg-danger">Deletado</span>
                                {% else %}
                                <span class="badge bg-secondary">{{ result.change_type or '-' }}</span>
                                {% endif %}
                            </td>
                            <td>
                                <code class="text-primary">
                                    {% if result.source_value is none %}
                                    <em class="text-muted">null</em>
                                    {% elif result.source_value|length > 50 %}
                                    {{ result.source_value[:50] }}...
                                    {% else %}
                                    {{ result.source_value }}
                                    {% endif %}
                                </code>
                            </td>
                            <td>
                                <code class="text-danger">
                                    {% if result.target_value is none %}
                                    <em class="text-muted">null</em>
                                    {% elif result.target_value|length > 50 %}
                                    {{ result.target_value[:50] }}...
                                    {% else %}
                                    {{ result.target_value }}
                                    {% endif %}
                                </code>
                            </td>
                            <td>
                                {% if result.target_record_json %}
                                <button class="btn btn-sm btn-info" type="button" data-bs-toggle="collapse" data-bs-target="#jsonRaw{{ result.id }}" aria-expanded="false" aria-controls="jsonRaw{{ result.id }}">
                                    <i class="fas fa-code me-1"></i>Ver JSON
                                </button>
                                <div class="collapse mt-2" id="jsonRaw{{ result.id }}">
                                    <pre class="bg-light p-2 rounded" style="max-height: 200px; overflow-y: auto; font-size: 0.85em;"><code>{{ result.target_record_json|tojson(indent=2) }}</code></pre>
                                    <small class="text-muted">
                                        <i class="fas fa-info-circle me-1"></i>
                                        Use <code>json_raw.campo</code> no namespace do webhook para acessar os dados
                                    </small>
                                </div>
                                {% else %}
                                <em class="text-muted">N/A</em>
                                {% endif %}
                            </td>
                            <td>
                                <small class="text-muted">
                                    {{ result.detected_at.strftime('%d/%m/%Y %H:%M:%S') if result.detected_at else '-' }}
                                </small>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% else %}
            <div class="alert alert-info">
                <i class="fas fa-info-circle me-2"></i>
                Nenhuma diferença encontrada entre as tabelas.
            </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- Modal para enviar todas as diferenças para webhook -->
<div class="modal fade" id="bulkWebhookModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="fas fa-paper-plane me-2"></i>Enviar Todas as Diferenças para Webhook</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="bulkWebhookForm">
                    <!-- Webhook Selection -->
                    <div class="mb-3">
                        <label class="form-label">Webhook Configurado *</label>
                        <select class="form-select" id="bulkWebhookConfigSelect" required>
                            <option value="">Carregando webhooks...</option>
                        </select>
                        <small class="text-muted">Selecione um webhook previamente configurado</small>
                    </div>
                    
                    <!-- Field Filter -->
                    <div class="mb-3">
                        <label class="form-label">Filtrar por Campo</label>
                        <select class="form-select" id="bulkFieldFilter">
                            <option value="">Todos os campos</option>
                        </select>
                        <small class="text-muted">Selecione um campo específico ou envie todos</small>
                    </div>
                    
                    <!-- Send Type -->
                    <div class="mb-3">
                        <label class="form-label">Enviar em *</label>
                        <div class="btn-group w-100" role="group">
                            <input type="radio" class="btn-check" name="bulkSendType" id="bulkSendTypeBody" value="body" checked>
                            <label class="btn btn-outline-primary" for="bulkSendTypeBody">
                                <i class="fas fa-code me-2"></i>Body (Payload)
                            </label>
                            <input type="radio" class="btn-check" name="bulkSendType" id="bulkSendTypeParams" value="params">
                            <label class="btn btn-outline-primary" for="bulkSendTypeParams">
                                <i class="fas fa-link me-2"></i>Parâmetros (Query String)
                            </label>
                        </div>
                    </div>
                    
                    <!-- Value Selection -->
                    <div class="mb-3">
                        <label class="form-label">Valor a Enviar *</label>
                        <div class="btn-group w-100" role="group">
                            <input type="radio" class="btn-check" name="bulkValueType" id="bulkValueTypeSource" value="source" checked>
                            <label class="btn btn-outline-info" for="bulkValueTypeSource">
                                Valor Origem
                            </label>
                            <input type="radio" class="btn-check" name="bulkValueType" id="bulkValueTypeTarget" value="target">
                            <label class="btn btn-outline-info" for="bulkValueTypeTarget">
                                Valor Destino
                            </label>
                        </div>
                    </div>
                    
                    <!-- Info -->
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle me-2"></i>
                        <strong>Como funciona:</strong> O sistema enviará uma requisição para cada diferença encontrada. 
                        Se você selecionar um campo específico (ex: "username"), serão enviadas todas as diferenças desse campo em loop.
                        O payload será processado com os namespaces <code>{% raw %}{{comparison.*}}{% endraw %}</code>, 
                        <code>{% raw %}{{difference.*}}{% endraw %}</code>, <code>{% raw %}{{project.*}}{% endraw %}</code> 
                        e <code>{% raw %}{{json_raw.*}}{% endraw %}</code> (dados completos do registro de destino, ex: <code>{% raw %}{{json_raw.email}}{% endraw %}</code>).
                    </div>
                    
                    <!-- Progress -->
                    <div id="bulkWebhookProgress" style="display: none;">
                        <div class="mb-2">
                            <strong>Progresso:</strong> <span id="bulkProgressText">0 / 0</span>
                        </div>
                        <div class="progress">
                            <div class="progress-bar progress-bar-striped progress-bar-animated" id="bulkProgressBar" role="progressbar" style="width: 0%"></div>
                        </div>
                        <div class="mt-2" id="bulkProgressLog" style="max-height: 200px; overflow-y: auto; font-size: 0.9em;">
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-primary" onclick="sendBulkWebhooks()" id="bulkSendBtn">
                    <i class="fas fa-paper-plane me-2"></i>Enviar Todas
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    const COMPARISON_ID = {{ comparison.id }};
    const COMPARISON_DATA = {
        id: {{ comparison.id }},
        project_id: {{ comparison.project_id }},
        executed_at: '{{ comparison.executed_at.isoformat() if comparison.executed_at else "" }}',
        status: '{{ comparison.status }}',
        total_differences: {{ comparison.total_differences or 0 }},
        results: [
            {% for result in results %}
            {
                id: {{ result.id }},
                record_id: {{ result.record_id|tojson }},
                field_name: {{ result.field_name|tojson }},
                source_value: {{ result.source_value|tojson }},
                target_value: {{ result.target_value|tojson }},
                target_record_json: {{ result.target_record_json|tojson|safe }},
                change_type: {{ result.change_type|tojson }},
                detected_at: '{{ result.detected_at.isoformat() if result.detected_at else "" }}'
            }{% if not loop.last %},{% endif %}
            {% endfor %}
        ]
    };
    
    // Export to JSON
    function exportToJSON() {
        const jsonContent = JSON.stringify(COMPARISON_DATA, null, 2);
        const blob = new Blob([jsonContent], { type: 'application/json' });
        const link = document.createElement('a');
        link.href = URL.createObjectURL(blob);
        link.download = `comparison_${COMPARISON_ID}_${new Date().getTime()}.json`;
        link.click();
    }
    
    // Export to CSV
    function exportToCSV() {
        const headers = ['ID do Registro', 'Campo', 'Tipo de Mudança', 'Valor Origem', 'Valor Destino', 'JSON_RAW', 'Data de Detecção'];
        const rows = COMPARISON_DATA.results.map(r => [
            r.record_id || '',
            r.field_name || '',
            r.change_type || '',
            r.source_value || '',
            r.target_value || '',
            r.target_record_json ? JSON.stringify(r.target_record_json) : '',
            r.detected_at || ''
        ]);
        
        const csvContent = [
            headers.join(','),
            ...rows.map(row => row.map(cell => {
                const cellStr = String(cell).replace(/"/g, '""');
                return `"${cellStr}"`;
            }).join(','))
        ].join('\n');
        
        const blob = new Blob(['\ufeff' + csvContent], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement('a');
        link.href = URL.createObjectURL(blob);
        link.download = `comparison_${COMPARISON_ID}_${new Date().getTime()}.csv`;
        link.click();
    }
    
    // Export to TXT
    function exportToTXT() {
        let txtContent = `RESULTADOS DA COMPARAÇÃO\n`;
        txtContent += `========================\n\n`;
        txtContent += `ID da Comparação: ${COMPARISON_DATA.id}\n`;
        txtContent += `Projeto ID: ${COMPARISON_DATA.project_id}\n`;
        txtContent += `Data de Execução: ${COMPARISON_DATA.executed_at}\n`;
        txtContent += `Status: ${COMPARISON_DATA.status}\n`;
        txtContent += `Total de Diferenças: ${COMPARISON_DATA.total_differences}\n\n`;
        txtContent += `DIFERENÇAS ENCONTRADAS\n`;
        txtContent += `======================\n\n`;
        
        if (COMPARISON_DATA.results.length === 0) {
            txtContent += `Nenhuma diferença encontrada.\n`;
        } else {
            COMPARISON_DATA.results.forEach((result, index) => {
                txtContent += `${index + 1}. Registro ID: ${result.record_id || 'N/A'}\n`;
                txtContent += `   Campo: ${result.field_name || 'N/A'}\n`;
                txtContent += `   Tipo: ${result.change_type || 'N/A'}\n`;
                txtContent += `   Valor Origem: ${result.source_value !== null && result.source_value !== undefined ? result.source_value : 'null'}\n`;
                txtContent += `   Valor Destino: ${result.target_value !== null && result.target_value !== undefined ? result.target_value : 'null'}\n`;
                txtContent += `   Data de Detecção: ${result.detected_at || 'N/A'}\n`;
                txtContent += `\n`;
            });
        }
        
        const blob = new Blob([txtContent], { type: 'text/plain;charset=utf-8;' });
        const link = document.createElement('a');
        link.href = URL.createObjectURL(blob);
        link.download = `comparison_${COMPARISON_ID}_${new Date().getTime()}.txt`;
        link.click();
    }
    
    // Webhook functionality
    const WEBHOOKS_API_BASE = '/api/webhooks';
    const AUTH_TOKEN = '{{ session.token|safe }}';
    const USER_ID = parseInt('{{ current_user.id }}');
    
    function getAuthHeaders() {
        const headers = {
            'Content-Type': 'application/json'
        };
        if (AUTH_TOKEN) {
            headers['Authorization'] = `Bearer ${AUTH_TOKEN}`;
        }
        if (USER_ID) {
            headers['X-User-Id'] = USER_ID;
        }
        return headers;
    }
    
    let webhookConfigs = [];
    
    async function openBulkWebhookModal() {
        const modal = new bootstrap.Modal(document.getElementById('bulkWebhookModal'));
        modal.show();
        
        // Reset progress
        $('#bulkWebhookProgress').hide();
        $('#bulkProgressBar').css('width', '0%').removeClass('bg-success bg-danger bg-warning').addClass('progress-bar-animated');
        $('#bulkProgressLog').empty();
        $('#bulkSendBtn').prop('disabled', false);
        
        // Load webhook configs
        await loadBulkWebhookConfigs();
        
        // Load field filter options
        loadFieldFilterOptions();
    }
    
    function loadFieldFilterOptions() {
        // Get unique field names from results
        const fieldNames = [...new Set(COMPARISON_DATA.results.map(r => r.field_name))].sort();
        const select = $('#bulkFieldFilter');
        select.empty();
        select.append('<option value="">Todos os campos</option>');
        
        fieldNames.forEach(fieldName => {
            const count = COMPARISON_DATA.results.filter(r => r.field_name === fieldName).length;
            select.append(`<option value="${fieldName}">${fieldName} (${count} diferença${count > 1 ? 's' : ''})</option>`);
        });
    }
    
    async function loadBulkWebhookConfigs() {
        try {
            const response = await fetch(`${WEBHOOKS_API_BASE}/configs`, {
                headers: getAuthHeaders()
            });
            const data = await response.json();
            
            webhookConfigs = data.configs || [];
            const select = $('#bulkWebhookConfigSelect');
            select.empty();
            
            if (webhookConfigs.length > 0) {
                select.append('<option value="">Selecione um webhook...</option>');
                webhookConfigs.forEach(config => {
                    select.append(`<option value="${config.id}">${config.name}</option>`);
                });
            } else {
                select.append('<option value="">Nenhum webhook configurado</option>');
            }
        } catch (error) {
            console.error('Error loading webhook configs:', error);
            $('#bulkWebhookConfigSelect').html('<option value="">Erro ao carregar webhooks</option>');
        }
    }
    
    async function sendBulkWebhooks() {
        const configId = $('#bulkWebhookConfigSelect').val();
        if (!configId) {
            alert('Selecione um webhook');
            return;
        }
        
        const config = webhookConfigs.find(c => c.id == configId);
        if (!config) {
            alert('Webhook não encontrado');
            return;
        }
        
        // Debug: log config to see what we have
        console.log('[WEBHOOK] Selected config:', {
            id: config.id,
            name: config.name,
            has_default_payload: !!config.default_payload,
            default_payload_length: config.default_payload ? config.default_payload.length : 0,
            default_payload_preview: config.default_payload ? config.default_payload.substring(0, 100) : 'none'
        });
        
        const fieldFilter = $('#bulkFieldFilter').val();
        const sendType = $('input[name="bulkSendType"]:checked').val();
        const valueType = $('input[name="bulkValueType"]:checked').val();
        
        // Filter results by field if specified
        let resultsToSend = COMPARISON_DATA.results;
        if (fieldFilter) {
            resultsToSend = resultsToSend.filter(r => r.field_name === fieldFilter);
        }
        
        if (resultsToSend.length === 0) {
            alert('Nenhuma diferença encontrada para enviar');
            return;
        }
        
        // Show progress
        $('#bulkWebhookProgress').show();
        $('#bulkSendBtn').prop('disabled', true);
        const progressBar = $('#bulkProgressBar');
        const progressText = $('#bulkProgressText');
        const progressLog = $('#bulkProgressLog');
        
        let successCount = 0;
        let errorCount = 0;
        
        // Build project data once
        const projectData = {
            id: COMPARISON_DATA.project_id,
            name: {{ project.name|tojson|safe }}
        };
        
        const comparisonData = {
            id: COMPARISON_DATA.id,
            project_id: COMPARISON_DATA.project_id,
            executed_at: COMPARISON_DATA.executed_at,
            status: COMPARISON_DATA.status,
            total_differences: COMPARISON_DATA.total_differences
        };
        
        // Send each result in sequence
        for (let i = 0; i < resultsToSend.length; i++) {
            const result = resultsToSend[i];
            const progress = ((i + 1) / resultsToSend.length) * 100;
            
            progressBar.css('width', progress + '%');
            progressText.text(`${i + 1} / ${resultsToSend.length}`);
            
            try {
                // Build difference data
                const differenceData = {
                    id: result.id,
                    comparison_id: result.comparison_id || COMPARISON_DATA.id,
                    record_id: result.record_id,
                    field_name: result.field_name,
                    source_value: result.source_value,
                    target_value: result.target_value,
                    target_record_json: result.target_record_json || {},
                    change_type: result.change_type,
                    detected_at: result.detected_at
                };
                
                let url = config.url;
                let payload = null;
                
                if (sendType === 'body') {
                    // Use template if available
                    console.log('[WEBHOOK] Config default_payload:', config.default_payload ? 'exists' : 'missing');
                    console.log('[WEBHOOK] Config default_payload value:', config.default_payload);
                    
                    if (config.default_payload && config.default_payload.trim()) {
                        try {
                            console.log('[WEBHOOK] Processing template:', config.default_payload.substring(0, 200));
                            const templateResponse = await fetch(`${WEBHOOKS_API_BASE}/process-template`, {
                                method: 'POST',
                                headers: getAuthHeaders(),
                                body: JSON.stringify({
                                    template: config.default_payload,
                                    comparison: comparisonData,
                                    difference: differenceData,
                                    project: projectData,
                                    json_raw: result.target_record_json || {}
                                })
                            });
                            
                            if (!templateResponse.ok) {
                                const errorText = await templateResponse.text();
                                console.error('[WEBHOOK] Template processing failed:', templateResponse.status, errorText);
                                throw new Error(`Template processing failed: ${templateResponse.status}`);
                            }
                            
                            const templateResult = await templateResponse.json();
                            console.log('[WEBHOOK] Template result:', templateResult);
                            payload = templateResult.processed;
                            console.log('[WEBHOOK] Processed payload:', payload);
                            
                            // Validate payload - ensure it's a valid object
                            if (!payload) {
                                console.warn('[WEBHOOK] Template processed result is null/undefined, using default payload');
                                payload = {
                                    record_id: result.record_id,
                                    field_name: result.field_name,
                                    change_type: result.change_type,
                                    detected_at: result.detected_at,
                                    value: valueType === 'source' ? result.source_value : result.target_value
                                };
                            } else if (typeof payload === 'string') {
                                // If payload is a string, try to parse it
                                try {
                                    payload = JSON.parse(payload);
                                    console.log('[WEBHOOK] Parsed string payload:', payload);
                                } catch (e) {
                                    console.warn('[WEBHOOK] Template result is not valid JSON, using as string value');
                                    payload = {raw: payload};
                                }
                            } else if (typeof payload !== 'object' || Array.isArray(payload)) {
                                // If payload is not an object, wrap it
                                console.warn('[WEBHOOK] Payload is not an object, wrapping:', typeof payload);
                                payload = {value: payload};
                            } else if (Object.keys(payload).length === 0) {
                                // If payload is empty object, use default
                                console.warn('[WEBHOOK] Template processed result is empty object, using default payload');
                                payload = {
                                    record_id: result.record_id,
                                    field_name: result.field_name,
                                    change_type: result.change_type,
                                    detected_at: result.detected_at,
                                    value: valueType === 'source' ? result.source_value : result.target_value
                                };
                            } else {
                                console.log('[WEBHOOK] Using processed template payload');
                            }
                        } catch (error) {
                            console.error('[WEBHOOK] Error processing template:', error);
                            // Fallback to default payload
                            payload = {
                                record_id: result.record_id,
                                field_name: result.field_name,
                                change_type: result.change_type,
                                detected_at: result.detected_at,
                                value: valueType === 'source' ? result.source_value : result.target_value
                            };
                        }
                    } else {
                        console.log('[WEBHOOK] No default_payload configured, using default payload');
                        // Build payload from difference data
                        payload = {
                            record_id: result.record_id,
                            field_name: result.field_name,
                            change_type: result.change_type,
                            detected_at: result.detected_at,
                            value: valueType === 'source' ? result.source_value : result.target_value
                        };
                    }
                } else {
                    // Build query params
                    const params = {
                        record_id: result.record_id,
                        field_name: result.field_name,
                        change_type: result.change_type,
                        detected_at: result.detected_at,
                        value: valueType === 'source' ? result.source_value : result.target_value
                    };
                    const queryString = Object.keys(params)
                        .map(key => `${encodeURIComponent(key)}=${encodeURIComponent(params[key])}`)
                        .join('&');
                    if (queryString) {
                        url += (url.includes('?') ? '&' : '?') + queryString;
                    }
                }
                
                // Send webhook
                const response = await fetch(`${WEBHOOKS_API_BASE}/send`, {
                    method: 'POST',
                    headers: getAuthHeaders(),
                    body: JSON.stringify({
                        url: url,
                        method: config.method || 'POST',
                        headers: config.headers || {},
                        payload: payload
                    })
                });
                
                const responseData = await response.json();
                
                if (response.ok) {
                    successCount++;
                    progressLog.append(`<div class="text-success"><i class="fas fa-check-circle me-1"></i>Enviado: ${result.field_name} (ID: ${result.record_id})</div>`);
                } else {
                    errorCount++;
                    progressLog.append(`<div class="text-danger"><i class="fas fa-times-circle me-1"></i>Erro: ${result.field_name} (ID: ${result.record_id}) - ${responseData.message || 'Erro desconhecido'}</div>`);
                }
                
                // Scroll to bottom
                progressLog.scrollTop(progressLog[0].scrollHeight);
                
                // Small delay between requests to avoid overwhelming the server
                if (i < resultsToSend.length - 1) {
                    await new Promise(resolve => setTimeout(resolve, 100));
                }
            } catch (error) {
                errorCount++;
                progressLog.append(`<div class="text-danger"><i class="fas fa-times-circle me-1"></i>Erro: ${result.field_name} (ID: ${result.record_id}) - ${error.message}</div>`);
                progressLog.scrollTop(progressLog[0].scrollHeight);
            }
        }
        
        // Show final result
        progressBar.removeClass('progress-bar-animated');
        if (errorCount === 0) {
            progressBar.addClass('bg-success');
        } else if (successCount === 0) {
            progressBar.addClass('bg-danger');
        } else {
            progressBar.addClass('bg-warning');
        }
        
        progressLog.append(`<div class="mt-2 alert ${errorCount === 0 ? 'alert-success' : errorCount > 0 && successCount > 0 ? 'alert-warning' : 'alert-danger'}"><strong>Concluído:</strong> ${successCount} sucesso(s), ${errorCount} erro(s)</div>`);
        
        $('#bulkSendBtn').prop('disabled', false);
    }
</script>
{% endblock %}

