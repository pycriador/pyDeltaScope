<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}DeltaScope{% endblock %}</title>
    <link rel="icon" type="image/svg+xml" href="{{ url_for('static', filename='favicon.svg') }}">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="{{ url_for('static', filename='css/style.css') }}" rel="stylesheet">
    <script>
        // Apply theme IMMEDIATELY before page renders to prevent flash
        (function() {
            try {
                const theme = localStorage.getItem('theme') || 'light';
                if (theme === 'dark') {
                    document.documentElement.classList.add('dark-theme');
                    document.body.classList.add('dark-theme');
                }
            } catch (e) {
                // Ignore errors
            }
        })();
    </script>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
        <div class="container-fluid">
            <a class="navbar-brand" href="/">
                <i class="fas fa-exchange-alt me-2"></i>DeltaScope
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                       <ul class="navbar-nav me-auto">
                           {% set user_groups_list = current_user.groups if current_user.groups else [] %}
                           {% if current_user.is_admin or user_groups_list|selectattr('can_create_connections')|list|length > 0 or user_groups_list|selectattr('can_create_projects')|list|length > 0 or user_groups_list|selectattr('can_view_dashboards')|list|length > 0 or user_groups_list|selectattr('can_view_tables')|list|length > 0 or user_groups_list|selectattr('can_view_reports')|list|length > 0 %}
                               <!-- Menu Executar -->
                               {% if current_user.is_admin or user_groups_list|selectattr('can_create_projects')|list|length > 0 %}
                               <li class="nav-item dropdown">
                                   <a class="nav-link dropdown-toggle {% if request.endpoint == 'comparison_template.comparison_page' or request.endpoint == 'scheduled_tasks_template.scheduled_tasks_page' or request.endpoint == 'webhooks_template.webhooks_client_page' %}active{% endif %}" href="#" id="executarDropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                                       <i class="fas fa-play-circle me-1"></i>Executar
                                   </a>
                                   <ul class="dropdown-menu" aria-labelledby="executarDropdown">
                                       <li>
                                           <a class="dropdown-item {% if request.endpoint == 'comparison_template.comparison_page' %}active{% endif %}" href="/comparacao" data-template-link="true">
                                               <i class="fas fa-code-branch me-2"></i>Comparação
                                           </a>
                                       </li>
                                       <li>
                                           <a class="dropdown-item {% if request.endpoint == 'scheduled_tasks_template.scheduled_tasks_page' %}active{% endif %}" href="/agendamentos" data-template-link="true">
                                               <i class="fas fa-clock me-2"></i>Agendamentos
                                           </a>
                                       </li>
                                       <li>
                                           <a class="dropdown-item {% if request.endpoint == 'webhooks_template.webhooks_client_page' %}active{% endif %}" href="/webhooks" data-template-link="true">
                                               <i class="fas fa-paper-plane me-2"></i>Cliente HTTP
                                           </a>
                                       </li>
                                   </ul>
                               </li>
                               {% endif %}
                               
                               <!-- Menu Dados -->
                               {% if current_user.is_admin or user_groups_list|selectattr('can_view_dashboards')|list|length > 0 or user_groups_list|selectattr('can_view_reports')|list|length > 0 %}
                               <li class="nav-item dropdown">
                                   <a class="nav-link dropdown-toggle {% if request.endpoint == 'dashboard_template.dashboard_page' or request.endpoint == 'reports_template.reports_page' %}active{% endif %}" href="#" id="dadosDropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                                       <i class="fas fa-chart-bar me-1"></i>Dados
                                   </a>
                                   <ul class="dropdown-menu" aria-labelledby="dadosDropdown">
                                       {% if current_user.is_admin or user_groups_list|selectattr('can_view_reports')|list|length > 0 %}
                                       <li>
                                           <a class="dropdown-item {% if request.endpoint == 'reports_template.reports_page' %}active{% endif %}" href="/relatorios" data-template-link="true">
                                               <i class="fas fa-file-alt me-2"></i>Relatórios
                                           </a>
                                       </li>
                                       {% endif %}
                                       {% if current_user.is_admin or user_groups_list|selectattr('can_view_dashboards')|list|length > 0 %}
                                       <li>
                                           <a class="dropdown-item {% if request.endpoint == 'dashboard_template.dashboard_page' %}active{% endif %}" href="/dashboard" data-template-link="true">
                                               <i class="fas fa-chart-line me-2"></i>Dashboard
                                           </a>
                                       </li>
                                       {% endif %}
                                   </ul>
                               </li>
                               {% endif %}
                               
                               <!-- Menu Administração -->
                               {% if current_user.is_admin or user_groups_list|selectattr('can_create_connections')|list|length > 0 or user_groups_list|selectattr('can_create_projects')|list|length > 0 or user_groups_list|selectattr('can_view_tables')|list|length > 0 %}
                               <li class="nav-item dropdown">
                                   <a class="nav-link dropdown-toggle {% if request.endpoint == 'users_template.users_page' or request.endpoint == 'groups_template.groups_page' or request.endpoint == 'tables_template.tables_page' or request.endpoint == 'connections_template.connections_page' or request.endpoint == 'projects_template.projects_page' %}active{% endif %}" href="#" id="administracaoDropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                                       <i class="fas fa-cog me-1"></i>Administração
                                   </a>
                                   <ul class="dropdown-menu" aria-labelledby="administracaoDropdown">
                                       {% if current_user.is_admin or user_groups_list|selectattr('can_create_connections')|list|length > 0 %}
                                       <li>
                                           <a class="dropdown-item {% if request.endpoint == 'connections_template.connections_page' %}active{% endif %}" href="/conexoes" data-template-link="true">
                                               <i class="fas fa-database me-2"></i>Conexões
                                           </a>
                                       </li>
                                       {% endif %}
                                       {% if current_user.is_admin or user_groups_list|selectattr('can_create_projects')|list|length > 0 %}
                                       <li>
                                           <a class="dropdown-item {% if request.endpoint == 'projects_template.projects_page' %}active{% endif %}" href="/projetos" data-template-link="true">
                                               <i class="fas fa-folder me-2"></i>Projetos
                                           </a>
                                       </li>
                                       {% endif %}
                                       {% if current_user.is_admin %}
                                       <li>
                                           <a class="dropdown-item {% if request.endpoint == 'users_template.users_page' %}active{% endif %}" href="/usuarios" data-template-link="true">
                                               <i class="fas fa-users me-2"></i>Usuários
                                           </a>
                                       </li>
                                       <li>
                                           <a class="dropdown-item {% if request.endpoint == 'groups_template.groups_page' %}active{% endif %}" href="/grupos" data-template-link="true">
                                               <i class="fas fa-user-friends me-2"></i>Grupos
                                           </a>
                                       </li>
                                       {% endif %}
                                       {% if current_user.is_admin or user_groups_list|selectattr('can_view_tables')|list|length > 0 %}
                                       <li>
                                           <a class="dropdown-item {% if request.endpoint == 'tables_template.tables_page' %}active{% endif %}" href="/tabelas" data-template-link="true">
                                               <i class="fas fa-table me-2"></i>Tabelas
                                           </a>
                                       </li>
                                       {% endif %}
                                   </ul>
                               </li>
                               {% endif %}
                    {% endif %}
                </ul>
                <div class="navbar-nav">
                    <button class="btn btn-outline-light btn-sm me-2" id="themeToggle" title="Alternar tema">
                        <i class="fas fa-moon" id="themeIcon"></i>
                    </button>
                    <span class="navbar-text me-3">Olá, {{ current_user.username }}</span>
                    <a href="/api-docs" class="btn btn-outline-light btn-sm me-2" target="_blank">
                        <i class="fas fa-book me-1"></i>API Docs
                    </a>
                    <a href="/api/auth/logout" class="btn btn-outline-light btn-sm" onclick="handleLogout(event);">
                        <i class="fas fa-sign-out-alt me-1"></i>Sair
                    </a>
                </div>
            </div>
        </div>
    </nav>

    <div class="main-app-container">
        {% block content %}{% endblock %}
    </div>
    
    <script>
        // Ensure navigation links work correctly on template pages
        // This runs IMMEDIATELY to prevent any interference from app.js
        (function() {
            // Only run on template pages (no mainApp element)
            if (!document.getElementById('mainApp')) {
                // Intercept clicks on template links BEFORE any other handlers
                document.addEventListener('click', function(e) {
                    const link = e.target.closest('a[data-template-link="true"]');
                    if (link && link.href && link.href !== '#' && !link.href.includes('javascript:')) {
                        // Force navigation using window.location
                        console.log('[NAV] Template link clicked, navigating to:', link.href);
                        e.preventDefault();
                        e.stopImmediatePropagation();
                        window.location.href = link.href;
                        return false;
                    }
                }, true); // Use capture phase to run FIRST, before any other listeners
            }
        })();
    </script>
    
    <script src="https://code.jquery.com/jquery-3.7.1.min.js" integrity="sha256-/JqT3SQfawRcv/BIHPThkBvs0OEvtFFmqPF/lYI/Cxo=" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="{{ url_for('static', filename='js/app.js') }}"></script>
    <script>
        // Theme management for template pages
        (function() {
            // Load theme preference
            function loadTheme() {
                try {
                    const savedTheme = localStorage.getItem('theme') || 'light';
                    if (savedTheme === 'dark') {
                        document.documentElement.classList.add('dark-theme');
                        document.body.classList.add('dark-theme');
                        updateThemeIcon(true);
                    } else {
                        document.documentElement.classList.remove('dark-theme');
                        document.body.classList.remove('dark-theme');
                        updateThemeIcon(false);
                    }
                } catch (error) {
                    console.warn('Could not load theme:', error);
                }
            }
            
            // Update theme icon
            function updateThemeIcon(isDark) {
                const icon = document.getElementById('themeIcon');
                if (icon) {
                    if (isDark) {
                        icon.classList.remove('fa-moon');
                        icon.classList.add('fa-sun');
                    } else {
                        icon.classList.remove('fa-sun');
                        icon.classList.add('fa-moon');
                    }
                }
            }
            
            // Toggle theme
            function toggleTheme() {
                try {
                    const isDark = document.body.classList.contains('dark-theme');
                    if (isDark) {
                        document.documentElement.classList.remove('dark-theme');
                        document.body.classList.remove('dark-theme');
                        localStorage.setItem('theme', 'light');
                        updateThemeIcon(false);
                    } else {
                        document.documentElement.classList.add('dark-theme');
                        document.body.classList.add('dark-theme');
                        localStorage.setItem('theme', 'dark');
                        updateThemeIcon(true);
                    }
                } catch (error) {
                    console.error('Error toggling theme:', error);
                }
            }
            
            // Initialize theme on page load
            loadTheme();
            
            // Setup toggle button click handler
            $(document).ready(function() {
                $('#themeToggle').on('click', function(e) {
                    e.preventDefault();
                    toggleTheme();
                });
            });
        })();
    </script>
    {% block scripts %}{% endblock %}
</body>
</html>

